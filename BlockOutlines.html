<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Workshop Schedule Builder</title>
<style>
 body { font-family: Arial, sans-serif; margin: 20px; }
 #controls { margin-bottom: 20px; }
 #grid { display: grid; border: 1px solid #000; }
  .cell { border: 1px solid #ccc; min-width: 100px; min-height: 25px; box-sizing: border-box; position: relative; }
  .cell.scheduled { background: #d0eaff; }
  .cell.scheduled.start { cursor: grab; }
 .module { padding: 5px; margin: 5px 0; background: #f0f0f0; border: 1px solid #ccc; cursor: grab; }
 .module:active { cursor: grabbing; }
 #moduleList { max-width: 200px; }
</style>
</head>
<body>
<h1>Workshop Schedule Builder</h1>
<div id="controls">
<label>Days:
<select id="daysSelect">
  <option value="1">1</option>
  <option value="2">2</option>
  <option value="3">3</option>
  <option value="4">4</option>
  <option value="5">5</option>
  <option value="10">10</option>
</select>
</label>
<label>Start Time:
<input type="time" id="startTime" value="08:00">
</label>
<label>End Time:
<input type="time" id="endTime" value="17:00">
</label>
<label>Module Group:
<select id="groupSelect"></select>
</label>
<div id="customModuleControls" style="margin-top:10px;">
  <label>Custom Duration (min):
    <input type="number" id="customDuration" min="5" step="5" value="30">
  </label>
  <label>Title:
    <input type="text" id="customTitle">
  </label>
  <button id="addCustomModuleBtn" type="button">Add Custom Module</button>
</div>
<button id="generateBtn">Generate Grid</button>
</div>
<div style="display:flex;">
<div id="moduleList"></div>
<div style="flex:1; overflow:auto;">
<div id="grid"></div>
</div>
</div>
<script>
const defaultModules = [];
for(let min=15; min<=90; min+=5){
  defaultModules.push({name:`Module ${min} min`, duration:min});
}

const groupNames = ["SA","PA","DA","PPA","POA","Default","MIM","ATS","PSDMxp","LDI"];
const moduleGroups = {};
groupNames.forEach(g => {
  moduleGroups[g] = [
    {name:`${g}-Teach`, duration:30},
    {name:`${g}-Application`, duration:45},
    ...defaultModules
  ];
});

const customModules = [];
const moduleList = document.getElementById('moduleList');
const groupSelect = document.getElementById('groupSelect');

groupNames.forEach(g => {
  const opt = document.createElement('option');
  opt.value = g;
  opt.textContent = g;
  groupSelect.appendChild(opt);
});
groupSelect.value = 'Default';

function renderModuleList(){
  moduleList.innerHTML = '';
  const selected = groupSelect.value;
  const mods = moduleGroups[selected].concat(customModules);
  mods.forEach(m => {
    const div = document.createElement('div');
    div.className = 'module';
    div.draggable = true;
    div.textContent = m.name;
    div.dataset.duration = m.duration;
    div.dataset.moduleName = m.name;
    div.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', m.duration);
      e.dataTransfer.setData('text/moduleName', m.name);
      e.dataTransfer.setData('text/fromGrid', 'false');
    });
    moduleList.appendChild(div);
  });
}

document.getElementById('addCustomModuleBtn').addEventListener('click', () => {
  const dur = parseInt(document.getElementById('customDuration').value);
  const title = document.getElementById('customTitle').value.trim();
  if(!dur || dur <= 0 || !title){
    alert('Duration and title required');
    return;
  }
  customModules.push({name:title, duration:dur});
  document.getElementById('customTitle').value = '';
  renderModuleList();
});

groupSelect.addEventListener('change', renderModuleList);

let moduleCounter = 0;
renderModuleList();

const gridContainer = document.getElementById('grid');

function dragStartScheduled(e){
  const cell = e.target;
  e.dataTransfer.setData('text/plain', cell.dataset.duration);
  e.dataTransfer.setData('text/moduleName', cell.dataset.moduleName);
  e.dataTransfer.setData('text/fromGrid', 'true');
  e.dataTransfer.setData('text/moduleId', cell.dataset.moduleId);
}

function unscheduleModule(moduleId){
  const cells = Array.from(gridContainer.querySelectorAll(`.cell[data-module-id='${moduleId}']`));
  cells.forEach(c => {
    c.classList.remove('scheduled', 'start');
    c.textContent = '';
    c.removeAttribute('data-module-id');
    c.removeAttribute('data-duration');
    c.removeAttribute('data-module-name');
    c.draggable = false;
    c.removeEventListener('dragstart', dragStartScheduled);
  });
}

function scheduleModule(name, duration, day, index, moduleId){
  const requiredCells = duration / 5;
  const cells = Array.from(gridContainer.querySelectorAll(`.cell[data-day='${day}']`));
  const targetCells = cells.slice(index, index + requiredCells);
  targetCells.forEach((c,i) => {
    c.classList.add('scheduled');
    c.dataset.moduleId = moduleId;
    c.dataset.duration = duration;
    c.dataset.moduleName = name;
    if(i===0){
      c.classList.add('start');
      c.textContent = `${name} (${duration}m)`;
      c.draggable = true;
      c.addEventListener('dragstart', dragStartScheduled);
    } else {
      c.textContent = '';
    }
  });
}

function minutesBetween(start, end){
  const [sh, sm] = start.split(':').map(Number);
  const [eh, em] = end.split(':').map(Number);
  return (eh*60+em)-(sh*60+sm);
}

function timeAdd(time, minutes){
  const [h, m] = time.split(':').map(Number);
  const total = h*60 + m + minutes;
  const hh = String(Math.floor(total/60)).padStart(2,'0');
  const mm = String(total%60).padStart(2,'0');
  return `${hh}:${mm}`;
}

function generateGrid(){
  gridContainer.innerHTML = '';
  const days = parseInt(document.getElementById('daysSelect').value);
  const start = document.getElementById('startTime').value;
  const end = document.getElementById('endTime').value;
  const totalMinutes = minutesBetween(start,end);
  if(totalMinutes <= 0){
    alert('End time must be after start time');
    return;
  }
  const rows = totalMinutes / 5;
  gridContainer.style.gridTemplateColumns = `repeat(${days}, 1fr)`;
  gridContainer.style.gridTemplateRows = `repeat(${rows}, 25px)`;
  for(let r=0;r<rows;r++){
    const timeLabel = timeAdd(start,r*5);
    for(let d=0; d<days; d++){
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.dataset.day = d;
      cell.dataset.time = timeLabel;
      cell.addEventListener('dragover', e => e.preventDefault());
      cell.addEventListener('drop', handleDrop);
      gridContainer.appendChild(cell);
    }
  }
}

function handleDrop(e){
  e.preventDefault();
  const duration = parseInt(e.dataTransfer.getData('text/plain'));
  const name = e.dataTransfer.getData('text/moduleName');
  const fromGrid = e.dataTransfer.getData('text/fromGrid') === 'true';
  const existingId = e.dataTransfer.getData('text/moduleId');
  const requiredCells = duration / 5;
  const day = parseInt(this.dataset.day);
  const cells = Array.from(gridContainer.querySelectorAll(`.cell[data-day='${day}']`));
  const index = cells.indexOf(this);
  if(index < 0) return;
  const targetCells = cells.slice(index, index + requiredCells);
  if(targetCells.length < requiredCells || targetCells.some(c => c.classList.contains('scheduled') && c.dataset.moduleId !== existingId)){
    alert('Not enough space for this module');
    return;
  }

  const moduleId = fromGrid ? existingId : `m${moduleCounter++}`;
  if(fromGrid){
    unscheduleModule(existingId);
  }
  scheduleModule(name, duration, day, index, moduleId);
}

document.getElementById('generateBtn').addEventListener('click', generateGrid);
// Ensure the grid renders even if the page load event does not fire
document.addEventListener('DOMContentLoaded', generateGrid);
</script>
</body>
</html>
